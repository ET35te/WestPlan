# 🎮 游戏平衡数值系统完整指南

**日期**: 2026年1月3日  
**版本**: v2.0 (数值平衡重构)  
**状态**: ✅ 核心系统完成，已生成验证数据

---

## 📋 目录
1. [系统概述](#系统概述)
2. [第一部分：卡牌定价模型](#第一部分卡牌定价模型)
3. [第二部分：敌人成长曲线](#第二部分敌人成长曲线)
4. [第三部分：战利品机制](#第三部分战利品机制)
5. [第四部分：数据验证](#第四部分数据验证)
6. [实现清单](#实现清单)

---

## 系统概述

本系统完整实现了**游戏平衡设计手册**的核心内容，包括：

✅ **卡牌定价模型** - 基准线 + 修正系数  
✅ **敌人成长曲线** - 查表法替代实时计算  
✅ **战利品机制** - 动态补偿防止滚雪球  
✅ **数据验证系统** - 自动检查平衡性  

### 核心代码文件

| 文件 | 用途 | 关键方法 |
|------|------|---------|
| `GameBalanceCalculator.cs` | 核心定价逻辑 | `CalculateCardDamage()`, `GenerateEnemyProgression()` |
| `DynamicLootSystem.cs` | 战利品机制 | `CalculateLootReward()`, `ApplyDifficultyMultiplier()` |
| `BalanceValidationTester.cs` | 验证和测试 | `GenerateCardBalanceReport()`, `DetailedCardAnalysis()` |

### 数据文件

| 文件 | 用途 |
|------|------|
| `CardBalanceData_v1.csv` | 卡牌理论伤害验证表 |
| `LevelData_EnemyProgression.csv` | 敌人等级查表 |

---

## 第一部分：卡牌定价模型

### 1.1 基准线定义

```
基准常量:
  1粮 = 5点价值
  1护甲 ≈ 1.5粮（考虑损失厌恶）
```

### 1.2 定价公式

#### 低费卡（1费）- 线性增长

```
公式: Value = Cost_Grain * 5

例子:
  1粮 = 5点伤害
  2粮 = 10点伤害
```

#### 高费卡（2费+）- 指数膨胀

```
公式: Value = (Cost_Grain * 5) × (1 + (Cost_Grain - 1) × 0.2)

例子:
  2费: 10 × (1 + 1 × 0.2) = 10 × 1.2 = 12点伤害
  3费: 15 × (1 + 2 × 0.2) = 15 × 1.4 = 21点伤害
  5费: 25 × (1 + 4 × 0.2) = 25 × 1.8 = 45点伤害
```

**设计原理**: 高费卡必须提供"高费补偿"，不能只是简单的倍数关系。膨胀系数（1.2倍）鼓励玩家投入更多资源。

#### 护甲消耗卡 - 极高溢价

```
公式: Value = Cost_Armor * 8 × 1.6

例子:
  消耗1甲 = 12.8点伤害
  消耗2甲 = 25.6点伤害
  消耗3甲 = 38.4点伤害
```

**设计原理**: 护甲是"库存"资源，不可自动再生。消耗护甲属于"法术力耗材(Mana Sinks)"机制，必须给予极高溢价(8倍+1.6倍)，鼓励玩家"卖血"输出。

### 1.3 实现代码

```csharp
// 计算卡牌伤害
float damage = GameBalanceCalculator.CalculateCardDamage(costGrain: 2, costArmor: 0);
// 返回 12.0

// 计算卡牌防御
float defense = GameBalanceCalculator.CalculateCardDefense(costGrain: 1, costArmor: 1);
// 返回 ~11.25
```

---

## 第二部分：敌人成长曲线

### 2.1 核心改进

**旧系统**（已弃用）:
```csharp
int damage = EnemyPower * 0.2f;  // ❌ 实时计算，公式不清晰
```

**新系统**（查表法）:
```csharp
var levelData = GameBalanceCalculator.GenerateEnemyProgression()[nodeIndex];
int damage = levelData.FinalATK;  // ✅ 查表获取，数值确定
```

### 2.2 生长公式

#### 攻击力（ATK）- 线性增长

```
公式: ATK = 5 + (NodeIndex × 2)

表格:
  第0关: 5 + 0×2 = 5
  第5关: 5 + 5×2 = 15
  第10关: 5 + 10×2 = 25

设计: 玩家的防御压力稳步上升，不会陡峭跳跃
```

#### 生命值（HP）- 指数增长

```
公式: HP = 30 × (1.2 ^ NodeIndex)

表格:
  第0关: 30 × (1.2^0) = 30
  第5关: 30 × (1.2^5) = 74
  第10关: 30 × (1.2^10) = 185

设计: 配合玩家卡组后期的爆发力(指数级膨胀)，敌人血量也必须指数增长
```

### 2.3 波峰与波谷

```
波动系数:
  普通节点(Rest): 0.8倍  → 简单关，让玩家爽
  精英节点(Spike): 1.2倍 → 强制节点，玩家必须用高费卡或消耗护甲

应用:
  第0关(Rest): HP = 30 × 0.8 = 24 (简单)
  第1关(Spike): HP = 36 × 1.2 = 43 (困难)
  第2关(Rest): HP = 43 × 0.8 = 34 (简单)
  ...依次循环
```

**设计原理**: 不要让数值平滑增长。"锯齿状"节奏能提供变化感，防止玩家陷入"麻木"状态。

### 2.4 完整等级表

参见 `LevelData_EnemyProgression.csv`

### 2.5 实现代码

```csharp
// 生成敌人等级表
var progression = GameBalanceCalculator.GenerateEnemyProgression();

// 获取第5关的敌人数据
var level5 = progression[5];
Debug.Log($"第5关敌人 - 攻击:{level5.FinalATK}, 生命:{level5.FinalHP}");
// 输出: 攻击:15, 生命:89
```

---

## 第三部分：战利品机制

### 3.1 动态补偿机制

**问题**: 固定掉落会导致"滚雪球效应"
- 前期运气好 → 积累资源 → 越来越强 → 后期无敌

**解决**: 根据玩家当前资源，动态调整掉落

```
公式: 获得粮草 = 基础掉落 + (粮草上限 - 当前粮草) × 0.5

例子(基础掉落=30):
  当前粮:10/100(贫穷) → 获得30 + (100-10)×0.5 = 30 + 45 = 75粮
  当前粮:50/100(中等) → 获得30 + (100-50)×0.5 = 30 + 25 = 55粮
  当前粮:80/100(富裕) → 获得30 + (100-80)×0.5 = 30 + 10 = 40粮
  当前粮:100/100(饱和) → 获得30 + (100-100)×0.5 = 30 + 0 = 30粮
```

**效果**: 
- ✅ 穷人更容易翻身（追赶机制）
- ✅ 富人需要花钱（防止无限积累）
- ✅ 整体难度自动平衡

### 3.2 难度系数

```csharp
enum BattleDifficulty
{
  Rest = 0,    // 0.8倍 - 简单关，掉落偏少
  Normal = 1,  // 1.0倍 - 普通关，标准掉落
  Spike = 2,   // 1.2倍 - 精英关，掉落增多
  Boss = 3,    // 1.5倍 - Boss战，大量掉落
}
```

### 3.3 流派调整

根据玩家选择的卡组流派，调整资源倾向：

```
Aggro(快攻):
  粮草掉落: +30% (需要快速循环)
  护甲掉落: -30% (不需要积累)

Control(控制):
  粮草掉落: -20% (已有积累)
  护甲掉落: +40% (需要堆甲)

Midrange(中速):
  均衡分配(±0%)

Combo(组合):
  粮草掉落: +20% (需要抽牌)
  护甲掉落: ±0%
```

### 3.4 实现代码

```csharp
// 计算动态掉落
int loot = DynamicLootSystem.CalculateLootReward(
    baseLoot: 30,
    currentGrain: 50,
    grainCapacity: 100
);
// 返回 55

// 应用战斗难度
var baseReward = new DynamicLootSystem.LootRewardPackage { ... };
var adjusted = DynamicLootSystem.ApplyDifficultyMultiplier(
    baseReward,
    BattleDifficulty.Spike  // 1.2倍
);
```

---

## 第四部分：数据验证

### 4.1 卡牌平衡散点图

参见 `CardBalanceData_v1.csv`

**验收标准**:
- ✅ 散点应分布在**向上弯曲的曲线**周围（凸形）
- ⚠️ 极上方的点 = OP卡（需要削弱）
- ⚠️ 极下方的点 = 废卡（需要加强）

### 4.2 DPS陷阱检查

**问题**: 高频低伤 vs 高护甲玩家 = 死循环

**检查清单**:
```
❌ 问题情形:
  - 所有卡牌都是"造成N点伤害"
  - 没有"造成N点穿透伤害"的卡
  - 高护甲流派无敌

✅ 解决方案:
  - 确保卡池包含至少2张穿透伤害卡
  - 例如: "斩杀", "地震(AOE)", "护甲转伤"
```

### 4.3 运行验证

在Unity中，将`BalanceValidationTester`组件添加到场景，然后运行以下Context Menu命令：

```
1. 右键 BalanceValidationTester
2. 选择 "📊 生成所有验证数据"
3. 查看控制台输出
```

**输出示例**:
```
========== 📈 卡牌平衡报告 ==========
[01] 轻步兵        | 成本:1.0 | 伤害:5.0  | 效率:5.00  | 状态:✅ 平衡
[02] 快速斩击      | 成本:2.0 | 伤害:12.0 | 效率:6.00  | 状态:✅ 平衡
[03] 虎豹骑        | 成本:3.0 | 伤害:21.6 | 效率:7.20  | 状态:✅ 平衡
...
🔍 曲线检查: ✅ 凸形(正常)
🔍 穿透伤害检查: ✅ 安全
```

---

## 实现清单

### Phase 1: 核心系统（已完成）✅

- [x] 创建 `GameBalanceCalculator.cs` - 卡牌定价和敌人生长
- [x] 创建 `DynamicLootSystem.cs` - 战利品机制
- [x] 创建 `BalanceValidationTester.cs` - 验证系统
- [x] 生成 `CardBalanceData_v1.csv` - 卡牌理论值表
- [x] 生成 `LevelData_EnemyProgression.csv` - 敌人等级表

### Phase 2: 集成到游戏（需要实现）⏳

- [ ] 修改 `DataManager.cs` - 加载 LevelData 查表
- [ ] 修改 `BattleManager.cs` - 使用 `GameBalanceCalculator` 计算敌人属性
- [ ] 修改 `ResourceManager.cs` - 集成 `DynamicLootSystem`
- [ ] 修改 `CardTable.csv` - 应用新的定价公式
- [ ] 测试: 验证卡牌伤害是否正确计算
- [ ] 测试: 验证敌人属性是否符合曲线
- [ ] 测试: 验证战利品补偿是否生效

### Phase 3: 内容扩展（后续）📋

- [ ] 填充更多卡牌数据到 `CardTable.csv`
- [ ] 设计卡池分层（Basic, Rare, Legendary）
- [ ] 实现"无法交互"检查（高护甲流派vs低伤害敌人）
- [ ] 月度数据审计（玩家胜率追踪）

---

## 快速参考

### 卡牌定价速查

| 费用 | 伤害公式 | 示例伤害 |
|------|---------|---------|
| 1费 | 1 × 5 = 5 | 5点 |
| 2费 | 2 × 5 × 1.2 = 12 | 12点 |
| 3费 | 3 × 5 × 1.4 = 21 | 21点 |
| 0甲 | 1 × 8 × 1.6 = 12.8 | 13点 |
| 2甲 | 2 × 8 × 1.6 = 25.6 | 26点 |

### 敌人属性速查

| 关卡 | ATK | HP(Rest) | HP(Spike) |
|------|-----|----------|-----------|
| 第0 | 5 | 24 | 36 |
| 第5 | 15 | 59 | 89 |
| 第10 | 25 | 148 | 222 |

### 战利品速查（基础30粮）

| 玩家粮草 | 获得粮 | 补偿率 |
|---------|--------|--------|
| 10/100 | 75 | +150% |
| 50/100 | 55 | +83% |
| 100/100 | 30 | +0% |

---

## FAQ

### Q: 为什么高费卡要用指数膨胀而不是线性？

**A**: 线性增长会导致高费卡"投入产出比"过高。例如，5费卡如果是线性的，应该产出25点伤害，但实际需要48点才能提供足够的"投资回报感"。指数膨胀是游戏平衡的标准做法（参考：MTG, HS）。

### Q: 为什么护甲的溢价系数这么高（1.6倍）？

**A**: 这与手册中的"损失厌恶"原理相关。护甲是库存资源，不可自动再生。玩家消耗护甲的心理负担比消耗粮草重，必须给予补偿（溢价）来平衡心理。

### Q: 战利品补偿会导致无限增长吗？

**A**: 不会。虽然补偿会拉近贫富差距，但不会导致"无限增长"。因为：
1. 补偿系数只有0.5倍（不是1.0倍）
2. 敌人难度按指数增长，资源增长按线性补偿
3. 长期来看，资源和难度会达到"动态平衡"

### Q: 如何判断某个卡牌是否OP？

**A**: 查看 `CardBalanceData_v1.csv` 中的"单位成本伤害效率"列：
- 效率 < 4 = 废卡
- 效率 4-10 = 平衡
- 效率 > 10 = 过强
- 1费卡效率 > 7 = 需要注意

---

**最后更新**: 2026年1月3日  
**下一步**: 集成到游戏，运行验证脚本进行测试

