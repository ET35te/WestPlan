# 🎭 敌人行为状态机设计文档 (Enemy FSM Design Doc)

**版本**：1.0  
**日期**：2026-01-10  
**设计者**：AI Assistant  
**用途**：West Plan 战斗系统核心逻辑

---

## 📌 概述

### 系统目标
敌人状态机（FSM）为战斗提供**多样化的敌人行为表现**，而非简单的固定伤害模式。通过状态转移，敌人会根据战场局势动态调整战术，提升战斗的**策略性和反复性**。

### 设计原则
1. **状态清晰**：每个状态有明确的触发条件和行为
2. **平衡性**：蓄力和反制机制互相制衡，玩家有应对窗口
3. **可调参**：所有阈值和倍数都是可配置的，便于难度平衡
4. **反馈充分**：每次状态变化都有日志输出和 UI 提示

---

## 🎯 状态设计详解

### 1️⃣ NORMAL（正常状态）

**触发条件**：
- 敌人血量 > 30%
- 初始状态

**行为逻辑**：
```csharp
伤害 = Ceil(敌人战力 × 0.2) - 玩家护甲
```

**例子**：
- 敌人战力 50，玩家护甲 5
- 伤害 = Ceil(50 × 0.2) - 5 = 10 - 5 = **5 点伤害**

**意图提示**：  
`⚔️ 敌军意图: 普通攻击  预计伤害: 5`

**何时转移**：
- 敌人血量 ≤ 30% → **CHARGING**（蓄力）
- 玩家连续出 ≥2 张牌 → **COUNTERATTACK**（反制）

---

### 2️⃣ CHARGING（蓄力状态）

**触发条件**：
- 敌人血量 ≤ 30%（生命危急）
- 敌人进入战术调整期

**持续时间**：  
1 回合（之后自动进入 POWER_STRIKE）

**行为逻辑**：
- 本回合**不攻击**（伤害 = 0）
- 积蓄力量，为下回合的重击做准备

**意图提示**：  
`⚠️ 敌军正在蓄力... 下回合发动强力一击！`

**打断机制**：
- 如果玩家在本回合造成 ≥50 伤害，蓄力被打断
- 敌人回到 NORMAL 状态
- 例子：玩家出了 3 张伤害卡（总伤害 60），敌人蓄力被打断

**何时转移**：
- 持续 1 回合后 → **POWER_STRIKE**
- 被打断 → **NORMAL**

---

### 3️⃣ POWER_STRIKE（强力一击）

**触发条件**：
- 从 CHARGING 自动进入（蓄力完成）

**持续时间**：  
1 回合（只执行一次强力攻击）

**行为逻辑**：
```csharp
伤害 = Ceil(敌人战力 × 0.2 × 2) - 玩家护甲
     = Ceil(基础伤害 × 2) - 玩家护甲
```

**例子**：
- 基础伤害 10，玩家护甲 5
- 强力一击伤害 = 10 × 2 - 5 = **15 点伤害**（是普通攻击的 3 倍）

**意图提示**：  
`💥 敌军发动强力一击！ 预计伤害: 15`

**飘字效果**：  
红色加粗 **"HEAVY BLOW!"**

**何时转移**：
- 执行完毕 → **NORMAL**（回到常态）

**战术意义**：
- 给玩家制造紧张感
- 但有 1 回合的预告时间（CHARGING 阶段）
- 玩家可在蓄力阶段集中防御或治疗

---

### 4️⃣ COUNTERATTACK（反制状态）

**触发条件**：
- 玩家在一回合内出牌 ≥ **2 张**（默认阈值）
- 敌人感知到玩家的进攻威胁

**持续时间**：  
1 回合

**行为逻辑**：
```csharp
伤害 = Ceil(基础伤害 × 1.5) - 玩家护甲
```

**例子**：
- 基础伤害 10，玩家护甲 5
- 反制伤害 = Ceil(10 × 1.5) - 5 = 15 - 5 = **10 点伤害**

**意图提示**：  
`🔄 敌军反制攻击！ 预计伤害: 10`

**飘字效果**：  
紫色 **"COUNTER!"**

**战术意义**：
- 惩罚玩家的激进策略
- 鼓励玩家精准使用卡牌，而非盲目堆砌
- 反制阈值可调整（2 张 → 3 张以降低敌人反制频率）

**何时转移**：
- 执行完毕 → **NORMAL**

---

### 5️⃣ WEAKENED（虚弱状态）

**触发条件**：
- 玩家使用特定的"虚弱卡"（待实现）
- 手动触发（不是自动转移）

**持续时间**：  
2 回合（默认值，可配置）

**行为逻辑**：
```csharp
伤害 = Ceil(基础伤害 × 0.5) - 玩家护甲
```

**例子**：
- 基础伤害 10，玩家护甲 5
- 虚弱状态伤害 = Ceil(10 × 0.5) - 5 = 5 - 5 = **0 点伤害**（被完全抵消）

**意图提示**：  
`😰 敌军陷入虚弱状态 (剩余 2 回合)`

**视觉反馈**：
- 敌人图像可显示灰度或虚弱特效
- 日志显示虚弱持续时间倒计时

**何时转移**：
- 计时器归零 → **NORMAL**

**平衡考量**：
- 虚弱卡应该是"中等强度"的卡牌
- 成本合理（消耗 1-2 粮草），效果显著但有限期

---

### 6️⃣ DESPERATE（绝望状态）

**触发条件**：
- 敌人血量 ≤ 10%（最后死亡线）
- 敌人发起"破釜沉舟"的最后冲锋

**持续时间**：  
直到敌人阵亡

**行为逻辑**：
```csharp
伤害 = Ceil(基础伤害 × 1.3) - Ceil(玩家护甲 × 0.5)
```
（伤害提升 30%，敌人防御下降，但不攻击）

**例子**：
- 基础伤害 10，玩家护甲 5
- 绝望伤害 = Ceil(10 × 1.3) - Ceil(5 × 0.5) = 13 - 3 = **10 点伤害**

**意图提示**：  
`🔥 敌军陷入绝望，发起疯狂进攻！`

**视觉反馈**：
- 敌人图像可显示"破裂"或"光晕"效果
- 背景可闪烁红色

**战术意义**：
- 最后的挑战：敌人即将死亡，但威胁反而增加
- 玩家需要在这最后关头守住防线
- 鼓励玩家保留防御卡到最后

**何时转移**：
- 敌人阵亡 → 战斗胜利

---

## 📊 状态转移图

```
                     ┌──────────────┐
                     │   NORMAL     │
                     │  (初始状态)   │
                     └──────┬───────┘
                      ◄──────┴──────►
       (敌人 HP ≤ 30%)        (玩家连出 2+ 张牌)
            │                       │
            ▼                       ▼
    ┌──────────────┐      ┌─────────────────┐
    │  CHARGING    │      │ COUNTERATTACK   │
    │ (蓄力1回合)  │      │   (反制1回合)   │
    └──────┬───────┘      └────────┬────────┘
           │                       │
    (满1回合或被打断)       (攻击完毕后)
           │                       │
           ▼                       ▼
    ┌──────────────┐              │
    │ POWER_STRIKE │              │
    │(强力一击)    │              │
    └──────┬───────┘              │
           │                       │
           │                  ▼
           │            ┌──────────────┐
           │            │   NORMAL     │
           └───────────►│  (重新开始)   │
                        └──────┬───────┘
                               │
                    (玩家使用虚弱卡)
                               │
                               ▼
                        ┌──────────────┐
                        │  WEAKENED    │
                        │ (2回合持续)  │
                        └──────┬───────┘
                               │
                        (计时器归零)
                               │
                               ▼
                           NORMAL

【绝望状态优先级最高】
如果敌人 HP ≤ 10%，无论当前状态是什么，都立即转为 DESPERATE
```

---

## 💾 状态机参数汇总

| 参数名 | 类型 | 默认值 | 作用 | 范围建议 |
|--------|------|--------|------|---------|
| `CriticalHPThreshold` | float | 0.3 | 触发蓄力的血量百分比 | 0.2 ~ 0.4 |
| `DespairHPThreshold` | float | 0.1 | 触发绝望的血量百分比 | 0.05 ~ 0.15 |
| `ConsecutiveCardThreshold` | int | 2 | 触发反制的连续出牌张数 | 2 ~ 3 |
| `WeaknessDefaultDuration` | int | 2 | 虚弱状态持续回合数 | 1 ~ 3 |
| `ChargePowerMultiplier` | float | 2.0 | 蓄力后的伤害倍数 | 1.5 ~ 2.5 |

---

## ⚙️ 参数平衡指南

### 难度调整策略

#### 🟢 简单模式
```csharp
CriticalHPThreshold = 0.2f;      // 更晚触发蓄力（更容易击败）
ChargePowerMultiplier = 1.5f;    // 蓄力伤害较弱
ConsecutiveCardThreshold = 3;    // 反制不易触发
```

#### 🟡 标准模式（当前）
```csharp
CriticalHPThreshold = 0.3f;
ChargePowerMultiplier = 2.0f;
ConsecutiveCardThreshold = 2;
```

#### 🔴 困难模式
```csharp
CriticalHPThreshold = 0.4f;      // 更早触发蓄力
ChargePowerMultiplier = 2.5f;    // 蓄力伤害强大
ConsecutiveCardThreshold = 2;    // 反制容易触发
DespairHPThreshold = 0.15f;      // 更早进入绝望模式
```

---

## 🔍 状态转移逻辑伪代码

```csharp
void UpdateState(float enemyHPPercent, int playerDamageLastTurn)
{
    // 1. 优先级最高：检查绝望条件
    if (enemyHPPercent <= DespairHPThreshold && state != DESPERATE)
    {
        state = DESPERATE;
        return; // 立即返回，不继续检查其他转移
    }

    // 2. 虚弱计数递减
    if (state == WEAKENED)
    {
        weaknessCounter--;
        if (weaknessCounter == 0)
            state = NORMAL;
    }

    // 3. 蓄力完成判定
    if (state == CHARGING)
    {
        chargeCounter++;
        if (chargeCounter >= 1)
            state = POWER_STRIKE;
    }

    // 4. 蓄力被打断判定
    if (state == CHARGING && playerDamageLastTurn >= 50)
    {
        state = NORMAL;
        chargeCounter = 0;
    }

    // 5. POWER_STRIKE 自动转为 NORMAL
    //    （在敌人行动后处理，见 EnemyTurnRoutine）

    // 6. 血量下降，触发蓄力
    if (enemyHPPercent <= CriticalHPThreshold && state == NORMAL)
    {
        state = CHARGING;
        chargeCounter = 0;
    }
}
```

---

## 🎨 敌人意图提示文本

| 状态 | 意图文本 | 颜色 | 飘字 |
|------|--------|------|------|
| NORMAL | `⚔️ 敌军意图: 普通攻击\n预计伤害: {dmg}` | 默认 | - |
| CHARGING | `⚠️ 敌军正在蓄力...\n下回合发动强力一击！` | 黄色 | - |
| POWER_STRIKE | `💥 敌军发动强力一击！\n预计伤害: {dmg}` | 红色 | "HEAVY BLOW!" |
| COUNTERATTACK | `🔄 敌军反制攻击！\n预计伤害: {dmg}` | 紫色 | "COUNTER!" |
| WEAKENED | `😰 敌军虚弱中\n预计伤害: {dmg}` | 灰色 | - |
| DESPERATE | `🔥 敌军拼死一搏！\n预计伤害: {dmg}` | 红色 | - |

---

## 🧪 测试用例

### 测试 1：正常转移到蓄力
```
1. 敌人初始血量 100，进入战斗
2. 玩家造成 75 伤害（血量 = 25）
3. 敌人血量百分比 = 25%（< 30% 阈值）
4. 期望结果：敌人进入 CHARGING 状态
```

### 测试 2：蓄力被打断
```
1. 敌人在 CHARGING 状态
2. 玩家在一回合出 3 张伤害卡，总伤害 60
3. 期望结果：敌人蓄力被打断，回到 NORMAL，本回合继续攻击
```

### 测试 3：反制触发
```
1. 敌人在 NORMAL 状态
2. 玩家连续出牌 2 张
3. 期望结果：敌人进入 COUNTERATTACK，下一回合伤害 x1.5
```

### 测试 4：虚弱应用
```
1. 敌人在 NORMAL 状态
2. 玩家使用虚弱卡
3. 期望结果：敌人进入 WEAKENED，持续 2 回合，伤害 x0.5
4. 第 3 回合：敌人自动回到 NORMAL
```

### 测试 5：绝望状态优先级
```
1. 敌人血量 8%（DESPERATE 阈值以下）
2. 无论当前状态是什么（CHARGING、WEAKENED 等）
3. 期望结果：立即转为 DESPERATE，伤害 x1.3
```

---

## 📈 对战局势分析

### 玩家优势期间
- **触发蓄力阶段** (CHARGING)
  - 敌人本回合 0 伤害
  - 玩家有 1 回合修整机会
  - 可积极出牌，组织防守或伤害

### 敌人优势期间
- **强力一击** (POWER_STRIKE): 伤害 x2
- **反制** (COUNTERATTACK): 伤害 x1.5
- **绝望** (DESPERATE): 伤害 x1.3，玩家护甲减半

### 平衡设计
- 敌人有强大的输出窗口，但都有**提前告知**机制
- 玩家有反应时间来应对（蓄力、反制都提前通知）
- 虚弱卡和治疗卡可打破常规，增加变数

---

## 🔮 未来扩展建议

1. **状态叠加**：敌人可同时进入多个状态（例如"虚弱+反制"）
2. **玩家 BUFF 系统**：玩家也有状态机，可获得增益或减益
3. **敌人个性化**：不同敌人配置不同的 FSM 参数
4. **多敌人群战**：处理多个敌人的状态管理和优先级
5. **终极技能**：敌人血量过低时的绝招（除了伤害提升外的特殊效果）

---

**文档版本历史**：
| 版本 | 日期 | 变更 |
|------|------|------|
| 1.0 | 2026-01-10 | 初版发布，定义 6 大状态和转移逻辑 |

