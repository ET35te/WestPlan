# 线性分支事件系统 - 快速测试指南

## 即刻开始测试

### 1. 前置条件
- [ ] 项目已编译无错误
- [ ] DataManager 已加载所有三个新CSV表
- [ ] 游戏主菜单正常显示

### 2. 运行测试流程

#### 第一关：显示剧情面板
```
1. 点击"新游戏"
2. 预期：显示 MessagePanel，内容为：
   标题: "丝路使者"
   内容: "大汉建初元年秋。班超奉皇帝之命出使西域..."
3. 确认：按钮正确为"To Be Continue"
```

#### 第二关：启动首个事件
```
4. 点击"To Be Continue"按钮
5. 预期：显示事件1001
   标题: "遭遇匈奴驿卒"
   内容: "前路遭遇来自西域的匈奴驿卒"
   按钮A: "选择战斗"
   按钮B: "选择贿赂"
6. 控制台应输出日志：
   ✅ 显示v2事件: [1001] 遭遇匈奴驿卒
```

#### 第三关：测试分支逻辑
```
测试1 - 战斗路线：
  7. 点击按钮A "选择战斗"
  8. 预期：显示结果 "士兵奋勇迎战\n伤害:30 信念+10"
  9. 显示ResultPanel（蓝色面板）
 10. 点击"确认"
 11. 预期：跳转到事件1002 "激烈的战斗"

测试2 - 贿赂路线：
  7. 返回事件1001（重新开局）
  8. 点击按钮B "选择贿赂"
  9. 预期：显示结果 "付出金钱换取通行\n粮食-20 信念-5"
 10. 点击"确认"
 11. 预期：跳转到事件1003 "权衡之后"
```

#### 第四关：测试条件判定
```
12. 如果事件中有条件限制，应看到按钮被置灰
    示例：如果选项条件为 "BELIEF>50"，但当前信念<50，则按钮灰化
```

#### 第五关：测试节点结束
```
13. 继续选择事件，最终到达事件1004 "抵达楼兰城"
    选项A: "谒见城主"  NextID: -1
    选项B: "休息驿站"  NextID: -1
14. 选择任意选项
15. 预期：显示结果后，进入节点结算
    控制台输出：📍 节点事件链结束
```

### 3. 日志检查清单

运行过程中，控制台应该出现这些日志（按顺序）：

```
🔄 开始新游戏：重置所有数据...
🎬 启动线性叙事系统...
🎬 启动节点剧情流程: Node 0
✅ 显示剧情面板: 丝路使者
✅ 显示v2事件: [1001] 遭遇匈奴驿卒
📋 显示事件结果
📍 节点事件链结束
```

### 4. 关键验证点

#### 验证点1：无随机性
```
重复进行相同操作3次，每次结果应完全一致：
1. 新游戏 → 剧情面板 → 事件1001
2. 选A（战斗）→ 事件1002
3. 选A（继续战斗）→ 事件1004
4. 结束

重复3遍，结果应该100%相同（无随机事件混入）
```

#### 验证点2：分支功能
```
对比两条分支：

分支A（战斗线）: 1001 → 选A → 1002 → 1004 → 节点结束
分支B（贿赂线）: 1001 → 选B → 1003 → 1004 → 节点结束

两条分支应该访问不同的事件（1002 vs 1003）
```

#### 验证点3：资源变化
```
观察每个事件的结果文本，确保资源变化被正确记录：
事件1001选B: "粮食-20 信念-5"
查看游戏内的资源数字是否真的减少

打开开发者工具查看 PlayerPrefs（或游戏内UI）
```

#### 验证点4：条件判定
```
制造一个条件判定的情况：
1. 修改 EventTable_v2.csv 中的某个选项条件为 "BELIEF>100"
2. 由于初始信念不足100，该选项按钮应置灰
3. 验证按钮确实变灰
4. 恢复条件（或增加信念），按钮应恢复可用
```

### 5. 常见问题排查

#### 问题：剧情面板不显示
```
检查清单：
- [ ] MessagePanel 在 Inspector 中已关联
- [ ] MessageText 在 Inspector 中已关联
- [ ] ShowStoryPanel() 是否被调用了？（查看日志）
```

#### 问题：事件不显示，直接进入结算
```
原因：可能事件ID不存在
检查：
- [ ] EventTable_v2.csv 中是否有该ID的事件？
- [ ] NextID_A/B 指向的ID存在吗？
- [ ] 控制台是否有 "❌ 找不到事件ID" 的错误？
```

#### 问题：按钮点击无反应
```
排查：
- [ ] ButtonA 和 ButtonB 在 Inspector 中已关联？
- [ ] 按钮是否被置灰（interactable=false）？
  如果是，检查条件判定是否有问题
- [ ] 点击时是否触发了 OnOptionSelected_v2？（查看日志）
```

#### 问题：资源不变化
```
排查：
- [ ] OptA_Result_Data 或 OptB_Result_Data 是否为空？
- [ ] 格式是否正确？（应该是 DAMAGE:50 或 ADD_RES:belief:20）
- [ ] ApplyMultiResources() 是否有bug？（查看日志输出）
```

### 6. 高级测试场景

#### 场景1：多条件判定
```
在 EventTable_v2.csv 中添加一个选项，条件为：
BELIEF>30&GRAIN<50

然后测试：
1. 信念>30且粮食<50 → 按钮可用
2. 信念<30但粮食<50 → 按钮置灰
3. 信念>30但粮食>50 → 按钮置灰
```

#### 场景2：复杂的事件链
```
在 EventTable_v2.csv 中添加更多事件（2002, 2003, 2004...）
每个事件都有明确的 NextID_A 和 NextID_B 指向

测试完整的5-10个事件的链式跳转
```

#### 场景3：节点结束验证
```
创建一个最小的节点事件链：
事件A (NextID_A: B, NextID_B: -1)
  选A → 事件B
  选B → 结束

测试：
1. 选A → 到达事件B
2. 从事件B的结果确认返回 → 进入节点结算
3. 验证节点结算的 UI 是否正确显示（NodeSummaryPanel）
```

### 7. 数据验证工具

#### Debug 日志快速查看
```csharp
// 在 GameManager 或 UIManager 的任何地方添加这行
// 来强制输出当前事件的详细信息

Debug.Log($"事件{eventID}:");
Debug.Log($"  A→{evt.NextID_A} | {evt.OptA_Text}");
Debug.Log($"  B→{evt.NextID_B} | {evt.OptB_Text}");
Debug.Log($"  效果: {evt.Effect_Type}");
```

#### 条件判定 Debug
```csharp
// 在 OnOptionSelected_v2 中添加这行来看条件评估过程
ConditionEvaluator.DebugEvaluate(condition, ResourceManager.Instance);
```

### 8. 测试完成标记

当所有以下条件都满足时，说明线性分支系统已成功实现：

- [x] 剧情面板正常显示
- [x] 事件按正确的顺序显示
- [x] 分支导向不同的事件
- [x] 同样的选择导致同样的结果（无随机性）
- [x] 资源正确变化
- [x] 条件判定有效
- [x] 节点结算正确触发
- [x] 无编译错误
- [x] 无明显的运行时错误

---

## 下一步

当测试完成后，请：

1. **补充事件数据**：在 EventTable_v2.csv 中添加更多事件，构建完整的 12 节点剧情
2. **测试多个节点**：验证 Node 1, 2, 3... 的剧情面板和事件链是否正常工作
3. **处理特殊效果**：测试 Effect_Type 字段（如 BATTLE: 战斗触发）
4. **优化 UI**：使用真实美术资源替换占位符面板

---

**预计测试时间**：15-30 分钟
**难度等级**：⭐⭐ (中等)
